---
title: "一句话和6位PIN转换成强密码"
author: "wurong"
date: "2025-08-19 18:43:53"
categories: "密码生成"
tags: [hash]
---

``` python
import argparse
import hashlib

# 固定字符集
LOWER = "abcdefghijklmnopqrstuvwxyz"
UPPER = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
DIGIT = "0123456789"
SYMB  = "@"
POOL  = LOWER + UPPER + DIGIT + SYMB

def phrase_to_password(phrase: str, pin: str, length: int = 10, rounds: int = 100_000) -> str:
    if length < 4:
        raise ValueError("length 至少为 4（需要覆盖四类字符）。")
    if not (pin.isdigit() and len(pin) == 6):
        raise ValueError("PIN 必须是 6 位数字。")

    # 派生足够多的字节
    dklen = max(length, 64)
    dk = hashlib.pbkdf2_hmac(
        "sha256",
        phrase.encode("utf-8"),
        pin.encode("utf-8"),  # 使用 6 位 PIN 作为 salt
        rounds,
        dklen=dklen
    )

    # 确保四类字符各一个
    picks = [
        LOWER[dk[0] % len(LOWER)],
        UPPER[dk[1] % len(UPPER)],
        DIGIT[dk[2] % len(DIGIT)],
        SYMB [dk[3] % len(SYMB )],
    ]

    # 剩余位置从全集补齐
    for i in range(4, length):
        picks.append(POOL[dk[i % len(dk)] % len(POOL)])

    # 洗牌
    j = 0
    for i in range(length - 1, 0, -1):
        j = (j + 1) % len(dk)
        k = dk[j] % (i + 1)
        picks[i], picks[k] = picks[k], picks[i]

    return "".join(picks)

def main():
    parser = argparse.ArgumentParser(description="把一句话 + 6位PIN 转换成强密码")
    parser.add_argument("phrase", help="输入的句子")
    parser.add_argument("pin", help="6位数字 PIN 作为 salt")
    parser.add_argument("--length", type=int, default=10, help="密码长度，默认10")
    args = parser.parse_args()

    pwd = phrase_to_password(args.phrase, args.pin, args.length)
    print(pwd)

if __name__ == "__main__":
    main()

```

## 如何运行脚本
保存成 genpwd.py

``` bash
HISTFILE=/dev/null bash
python3 genpwd.py 我就记住这句话和一个6为PIN就能得到密码 123456
```
**注意一定要使用HISTFILE=/dev/null bash，否则history里会记录密码导致泄露**

## 加密脚本

``` python
import argparse
import base64
import hashlib
import getpass
from cryptography.fernet import Fernet

# 从密码生成 Fernet key
def password_to_key(password: str) -> bytes:
    digest = hashlib.sha256(password.encode()).digest()
    return base64.urlsafe_b64encode(digest)

# 加密文件
def encrypt_file(filename: str, key: bytes):
    fernet = Fernet(key)
    with open(filename, "rb") as file:
        original = file.read()
    encrypted = fernet.encrypt(original)
    with open(filename + ".enc", "wb") as encrypted_file:
        encrypted_file.write(encrypted)
    print(f"加密完成: {filename} → {filename}.enc")

# 解密文件
def decrypt_file(filename: str, key: bytes):
    fernet = Fernet(key)
    with open(filename, "rb") as enc_file:
        encrypted = enc_file.read()
    try:
        decrypted = fernet.decrypt(encrypted)
    except Exception:
        print("错误：无法解密文件。可能是密码错误、文件损坏或该文件不是有效的加密文件。")
        exit(1)
    out_file = filename[:-4]  # 去掉 .enc
    with open(out_file, "wb") as dec_file:
        dec_file.write(decrypted)
    print(f"解密完成: {filename} → {out_file}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="文件加解密工具 (基于 cryptography.Fernet)")
    parser.add_argument("filename", help="要加密/解密的文件")
    args = parser.parse_args()

    # 安全地输入密码（不会显示在屏幕、history、ps 里）
    password = getpass.getpass("请输入密码: ")
    key = password_to_key(password)

    if args.filename.endswith(".enc"):
        decrypt_file(args.filename, key)
    else:
        encrypt_file(args.filename, key)

```

保存成 encrypt.py

``` bash
python3 encrypt.py 要加/解密的文件
```

